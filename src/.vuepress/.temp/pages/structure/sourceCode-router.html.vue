<template><div><nav class="table-of-contents"><ul><li><router-link to="#介绍">介绍</router-link></li><li><router-link to="#入口文件">入口文件</router-link></li><li><router-link to="#路由">路由</router-link></li><li><router-link to="#初始化路由流程">初始化路由流程</router-link><ul><li><router-link to="#initdynamicrouters">initDynamicRouters</router-link></li><li><router-link to="#loaddynamicrouters">loadDynamicRouters</router-link></li></ul></li><li><router-link to="#总结">总结</router-link></li></ul></nav>
<h2 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h2>
<p>Admin 在完成页面渲染的期间，进行了很多的逻辑处理，那么如果要想二次开发 Admin，则必须了解 Admin 的构建流程，这样才能根据需求切入源码，进行二次开发。</p>
<h2 id="入口文件" tabindex="-1"><a class="header-anchor" href="#入口文件" aria-hidden="true">#</a> 入口文件</h2>
<p>Admin 的入口和所有的 Vue 项目一样，都是 <code v-pre>main.ts</code> 文件，这个文件引用并注册了全局的依赖：</p>
<ul>
<li>Pinia</li>
<li>Element Plus</li>
<li>router</li>
<li>directives</li>
<li>i18n</li>
<li>svg icon</li>
<li>error handler</li>
<li>Auth</li>
<li>Role</li>
<li>App.vue</li>
</ul>
<p>这些都是 Admin 的全局依赖，也是 Admin 运行的基础环境。</p>
<h2 id="路由" tabindex="-1"><a class="header-anchor" href="#路由" aria-hidden="true">#</a> 路由</h2>
<p>在入口文件初始化后，就开启了路由功能，因此就会先走路由的前置拦截器 beforeEach，在 <code v-pre>src/router/index.ts</code> 里。</p>
<p>在 beforeEach 中，先引入了部分变量</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token comment">// 用户相关信息</span>
<span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">useUserStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 权限相关信息</span>
<span class="token keyword">const</span> permissionStore <span class="token operator">=</span> <span class="token function">usePermissionStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 初始化动态路由函数</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> initDynamicRouters <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 认证 token</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> userStore<span class="token punctuation">.</span>token<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后开启了 NProgress 进度条</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code>NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接下来进行一系列的链接、白名单、token 判断：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token comment">// 判断是访问登陆页，有 Token 就在当前页面，没有 Token 重置路由并放行到登陆页</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resetRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 判断访问页面是否在路由白名单地址中，如果存在直接放行</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permissionStore<span class="token punctuation">.</span>loadedRouteList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化路由流程函数</span>
    <span class="token keyword">await</span> <span class="token function">initDynamicRouters</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化结束后才放行</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>to<span class="token punctuation">,</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">)</span> <span class="token operator">||</span> whiteList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 判断是否有 Token，没有重定向到 login</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">"/login"</span><span class="token punctuation">,</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果都通过了判断，代表权限已经满足访问条件，那么此时面临两个选择：</p>
<ul>
<li>如果路由已经初始化，即已经进入了页面，因为此时是切换路由，则直接放行</li>
<li>如果路由没有初始化，则需要初始化路由，因此下面的流程都是进入 <a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%B7%AF%E7%94%B1%E6%B5%81%E7%A8%8B">初始化路由流程</a> 里进行分析</li>
</ul>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre typescript="" class="language-typescript"><code><span class="token comment">// 判断是否存在角色或加载过路由，如果不存在，则加载路由</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>permissionStore<span class="token punctuation">.</span>loadedRouteList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化路由流程函数</span>
    <span class="token keyword">await</span> <span class="token function">initDynamicRouters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化结束后才放行</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>to<span class="token punctuation">,</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 出现异常，则重置 token，并跳转登录页面</span>
    userStore<span class="token punctuation">.</span><span class="token function">resetToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">LOGIN_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 已经加载过路由，则直接放行</span>
<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="highlight-lines"><br><br><br><br><div class="highlight-line">&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后在 <code v-pre>afterEach</code> 关闭进度条：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code>NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果出现异常，则捕获并关闭进度条：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 路由跳转错误
 **/</span>
router<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>error <span class="token operator">=></span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"路由错误"</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="初始化路由流程" tabindex="-1"><a class="header-anchor" href="#初始化路由流程" aria-hidden="true">#</a> 初始化路由流程</h2>
<p>初始化路由流程是 <code v-pre>src/router/index.ts</code> 的 <code v-pre>router.beforeEach</code> 里触发 <code v-pre>initDynamicRouters</code> 函数，因此走进 <code v-pre>initDynamicRouters</code> 函数，位于 <code v-pre>src/hooks/useRoutes.ts</code> 文件下，这个文件是路由初始化、操作的核心 hooks 文件，里面包含项目路由操作的各个封装函数。</p>
<h3 id="initdynamicrouters" tabindex="-1"><a class="header-anchor" href="#initdynamicrouters" aria-hidden="true">#</a> initDynamicRouters</h3>
<p><code v-pre>initDynamicRouters</code> 函数主要是对路由进行初始化的入口，接收两个参数：</p>
<ul>
<li>第一个是角色，用来筛选角色路由</li>
<li>第二个参数是 api，如果传了 api，则调用 api 去后台获取动态路由</li>
</ul>
<p>第一次进来该函数将面临两个选择：</p>
<ul>
<li>如果缓存功能开启，则去 localstorage 里获取缓存的路由，如果存在则直接初始化</li>
<li>如果缓存不存在或者缓存功能不开启，则取后台 / 静态文件获取路由，然后再根据是否开启缓存功能进行缓存，最终初始化获取的路由</li>
</ul>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">initDynamicRouters</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>roles<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> api<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>BackstageMenuList<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheDynamicRoutes<span class="token punctuation">,</span> cacheDynamicRoutesKey <span class="token punctuation">}</span> <span class="token operator">=</span> settings<span class="token punctuation">;</span>
  <span class="token keyword">let</span> routeList<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> isCacheDynamicRoutes <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 先从缓存拿后台路由</span>
  <span class="token keyword">let</span> cacheRoutes <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>cacheDynamicRoutesKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果不开启缓存，但缓存路由存在，则清掉缓存里的路由和拿到的缓存路由</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheDynamicRoutes <span class="token operator">&amp;&amp;</span> cacheRoutes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span>cacheDynamicRoutesKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cacheRoutes <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheRoutes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    routeList <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>cacheRoutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isCacheDynamicRoutes <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">)</span> routeList <span class="token operator">=</span> <span class="token function">getDynamicRouters</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">api</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> routeList <span class="token operator">=</span> rolesRoutes<span class="token punctuation">;</span>
  <span class="token comment">// else routeList = getDynamicRouters(await getMenuList()); // 请求后台拿到菜单，并处理成路由</span>

  <span class="token comment">// 缓存后台路由</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheDynamicRoutes <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isCacheDynamicRoutes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>cacheDynamicRoutesKey<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>routeList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>routeList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ElNotification</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      title<span class="token operator">:</span> <span class="token string">"无权限访问"</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">"当前账号无任何菜单权限，请联系系统管理员！"</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">"warning"</span><span class="token punctuation">,</span>
      duration<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userStore<span class="token punctuation">.</span><span class="token function">resetToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">LOGIN_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">"No permission"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>roles <span class="token operator">||</span> <span class="token operator">!</span>roles<span class="token punctuation">.</span>length<span class="token punctuation">)</span> roles <span class="token operator">=</span> <span class="token keyword">await</span> userStore<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">loadDynamicRouters</span><span class="token punctuation">(</span>routeList<span class="token punctuation">,</span> roles <span class="token operator">||</span> settings<span class="token punctuation">.</span>whiteList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至于是去后台还是静态文件获取路由，则取决于自己的业务，可以二选一，也可以都选，最终 Admin 只接收一个 router 数组，都选的话则需要需要组装成一个数组。</p>
<p>如果是后台获取路由，如果后台返回的路由规则和官方需要的不一致，则 Admin 提供了 <code v-pre>getDynamicRouters</code> 函数进行转换。</p>
<h4 id="getdynamicrouters" tabindex="-1"><a class="header-anchor" href="#getdynamicrouters" aria-hidden="true">#</a> getDynamicRouters</h4>
<p>getDynamicRouters 函数处理后台返回的路由，当然如果你后台返回的路由规则和官方需要的一致，则无需该函数进行转换。</p>
<p>假设后台返回的路由形式是：</p>
<div class="language-json line-numbers-mode" data-ext="json"><pre v-pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    menuUrl<span class="token operator">:</span> <span class="token string">"/components"</span><span class="token punctuation">,</span>
    menuCode<span class="token operator">:</span> <span class="token string">"Components"</span><span class="token punctuation">,</span>
    menuName<span class="token operator">:</span> <span class="token string">"组件"</span><span class="token punctuation">,</span>
    parentMenuCode<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token comment">// 代表一级菜单</span>
    imageIcon<span class="token operator">:</span> <span class="token string">"Opportunity"</span><span class="token punctuation">,</span>
    sel<span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    menuUrl<span class="token operator">:</span> <span class="token string">"message"</span><span class="token punctuation">,</span>
    menuCode<span class="token operator">:</span> <span class="token string">"MessageDemo"</span><span class="token punctuation">,</span>
    pagePath<span class="token operator">:</span> <span class="token string">"/components/message/index"</span><span class="token punctuation">,</span>
    menuName<span class="token operator">:</span> <span class="token string">"消息组件"</span><span class="token punctuation">,</span>
    parentMenuCode<span class="token operator">:</span> <span class="token string">"Components"</span><span class="token punctuation">,</span> <span class="token comment">// 和上面的 menuCode 关联</span>
    imageIcon<span class="token operator">:</span> <span class="token string">"StarFilled"</span><span class="token punctuation">,</span>
    sel<span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>则我们需要转换成：</p>
<div class="language-json line-numbers-mode" data-ext="json"><pre v-pre class="language-json"><code><span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">"/components"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"Components"</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"组件"</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> <span class="token string">"Opportunity"</span><span class="token punctuation">,</span> rank<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">"message"</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">"MessageDemo"</span><span class="token punctuation">,</span>
      component<span class="token operator">:</span> <span class="token string">"/components/message/index"</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"消息组件"</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> <span class="token string">"StarFilled"</span><span class="token punctuation">,</span> rank<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么 getDynamicRouters 函数的内容是：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> getDynamicRouters <span class="token operator">=</span> <span class="token punctuation">(</span>routerList<span class="token operator">:</span> BackstageMenuList<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> menuCode <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dynamicRouterList<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  routerList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>parentMenuCode <span class="token operator">===</span> menuCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">getDynamicRouters</span><span class="token punctuation">(</span>
        routerList<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>v <span class="token operator">=></span> v<span class="token punctuation">.</span>menuCode <span class="token operator">!==</span> menuCode<span class="token punctuation">)</span><span class="token punctuation">,</span>
        item<span class="token punctuation">.</span>menuCode
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> menu <span class="token operator">=</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> item<span class="token punctuation">.</span>menuUrl<span class="token punctuation">,</span>
        name<span class="token operator">:</span> item<span class="token punctuation">.</span>menuName<span class="token punctuation">,</span>
        component<span class="token operator">:</span> item<span class="token punctuation">.</span>pagePath<span class="token punctuation">,</span>
        meta<span class="token operator">:</span> <span class="token punctuation">{</span>
          title<span class="token operator">:</span> item<span class="token punctuation">.</span>menuName<span class="token punctuation">,</span>
          icon<span class="token operator">:</span> item<span class="token punctuation">.</span>imageIcon<span class="token punctuation">,</span>
          rank<span class="token operator">:</span> item<span class="token punctuation">.</span>seq<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> dynamicRouterList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>menu<span class="token punctuation">,</span> children <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> dynamicRouterList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>menu <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dynamicRouterList<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>后台返回的路由规则 Admin 无法统一，所以 getDynamicRouters 提供转换方式也需要根据自己的场景进行修改。</p>
<h3 id="loaddynamicrouters" tabindex="-1"><a class="header-anchor" href="#loaddynamicrouters" aria-hidden="true">#</a> loadDynamicRouters</h3>
<p>在 <code v-pre>initDynamicRouters</code> 函数里，我们进行了缓存功能的操作、路由的获取，那么最终调用 <code v-pre>loadDynamicRouters</code> 方法，将获取到的路由和角色权限传进去。</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token function">loadDynamicRouters</span><span class="token punctuation">(</span>routeList<span class="token punctuation">,</span> roles <span class="token operator">||</span> settings<span class="token punctuation">.</span>whiteList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code v-pre>loadDynamicRouters</code> 函数将执行动态加载路由，但是在执行动态加载路由的前面，会执行四个函数来进行路由的处理，最后将处理后的路由进行动态加载：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">loadDynamicRouters</span> <span class="token operator">=</span> <span class="token punctuation">(</span>routers<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> roles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r <span class="token operator">=</span> router<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 权限路由筛选</span>
  <span class="token keyword">const</span> onlyRolesRoutes <span class="token operator">=</span> <span class="token function">filterOnlyRolesRoutes</span><span class="token punctuation">(</span>routers<span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 路由元数据处理</span>
  <span class="token keyword">const</span> resolveRouters <span class="token operator">=</span> <span class="token function">processDynamicRoutes</span><span class="token punctuation">(</span><span class="token function">processRouteMeta</span><span class="token punctuation">(</span>onlyRolesRoutes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 传到 permissionStore 持久化，并拿到扁平化的路由数组（所有二级以上的路由拍成一级，keep-alive 只支持到二级缓存（Layout 默认是一级，加起来就是二级））</span>
  <span class="token keyword">const</span> flatRouteList <span class="token operator">=</span> permissionStore<span class="token punctuation">.</span><span class="token function">loadPermissionRoutes</span><span class="token punctuation">(</span>resolveRouters<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此这四个函数是：</p>
<ul>
<li>filterOnlyRolesRoutes：根据传来的 roles 对路由进行角色路由筛选，筛选出只有该 roles 才能看到的路由</li>
<li>processRouteMeta：对路由的配置项进行处理，专门处理 meta 的配置项</li>
<li>processDynamicRoutes：对路由的元数据进行处理，如 redirect、name，如果开发者没有填写这些配置，则自动按照 Admin 规则生成</li>
<li>loadPermissionRoutes：将处理后的动态路由持久化到 Pinia，并返回一个扁平化的路由</li>
</ul>
<div class="hint-container tip">
<p class="hint-container-title">提示</p>
<p>什么是扁平化路由，就是将所有二级以上的路由拍成一级路由。</p>
</div>
<p>最后将扁平化的路由进行动态加载：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token comment">// ...</span>
flatRouteList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>flatRoute <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>flatRoute <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 解除响应式</span>
  item<span class="token punctuation">.</span>children <span class="token operator">?</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span> <span class="token comment">// 防止加载 children 而不加载提取出来变成的一级路由</span>
  item<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>_fullPath <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">||</span> item<span class="token punctuation">.</span>path<span class="token punctuation">;</span> <span class="token comment">// 加载动态路由时，子路由的 path 可能不带 /，这样会依赖父路由来拼接（vue-route 规则），但是 template 实现多级路由缓存，所以都拍成二级路由，则 path 加载时要求是完整的，不再放到父路由的 children 里</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">hasRoute</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>meta<span class="token operator">?.</span>isFull<span class="token punctuation">)</span> r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>item <span class="token keyword">as</span> RouteRecordRaw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> r<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span><span class="token string">"Layout"</span><span class="token punctuation">,</span> item <span class="token keyword">as</span> RouteRecordRaw<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最后添加 notFoundRouter</span>
router<span class="token punctuation">.</span><span class="token function">addRoute</span><span class="token punctuation">(</span>notFoundRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>动态加载路由有两个选择：</p>
<ul>
<li>如果路由已经存在则不加载</li>
<li>如果路由不存在：
<ul>
<li>如果路由配置了全屏 <code v-pre>isFull</code>，则将路由作为一级路由进行注册</li>
<li>如果路由没有配置全屏 <code v-pre>isFull</code>，则将路由动态加载 Layout 路由下，也就是 Layout 是一级路由，扁平化的路由是二级路由、三级路由</li>
</ul>
</li>
</ul>
<p>Layout 路由是布局路由，如顶部、标签栏、左侧菜单栏等都是布局内容，二级路由则在 MainContent 内容区里。</p>
<p>最后添加错误路由，这是 404 路由。</p>
<h4 id="filteronlyrolesroutes" tabindex="-1"><a class="header-anchor" href="#filteronlyrolesroutes" aria-hidden="true">#</a> filterOnlyRolesRoutes</h4>
<p>onlyRolesRoutes 函数是来过滤出当前系统角色的路由权限，因此需要接收两个参数，第一个参数是路由表，第二个参数是 roles 角色。</p>
<p>过滤出权限路由，取决于路由表的 <code v-pre>meta.roles</code> 配置，如果配置了 <code v-pre>meta.roles</code>，则与第二个参数 roles 比对，如果存在则通过，反之则去掉。如果没有配置 <code v-pre>meta.roles</code>，则默认通过。</p>
<p>因为路由表存在多级路由，所以采用递归形式遍历每个路由。</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">filterOnlyRolesRoutes</span> <span class="token operator">=</span> <span class="token punctuation">(</span>routers<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> roles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rolesRoutes<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  routers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>router <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>router <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasPermission</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> r<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">filterOnlyRolesRoutes</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>children<span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
      rolesRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> rolesRoutes<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
   * <span class="token keyword">@description</span> 该系统角色是否有权限访问当前路由
   * roles 带有 * 的代表所有路由都能访问
   */</span>
<span class="token keyword">const</span> <span class="token function-variable function">hasPermission</span> <span class="token operator">=</span> <span class="token punctuation">(</span>router<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">,</span> roles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>roles<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>roles<span class="token punctuation">)</span> <span class="token keyword">return</span> roles<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>role <span class="token operator">=></span> router<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>meta<span class="token operator">?.</span>roles<span class="token operator">?.</span><span class="token function">includes</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 没有添加权限验证</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终返回 <code v-pre>meta.roles</code> 存在第二个参数 roles 的路由或者没有配置 <code v-pre>meta.roles</code> 的路由。</p>
<p>如：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre typescript="" class="language-typescript"><code><span class="token keyword">const</span> permissionRoutes <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">"/role"</span><span class="token punctuation">,</span>
  <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"@/views/permission/rolePermission.vue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"RolePermission"</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">"权限编辑"</span><span class="token punctuation">,</span>
    roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"admin"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    icon<span class="token operator">:</span> <span class="token string">"StarFilled"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><div class="highlight-line">&nbsp;</div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当第二个参数 roles 也有 admin 的时候，则该路由允许加载到 Admin 里。</p>
<h4 id="processroutemeta" tabindex="-1"><a class="header-anchor" href="#processroutemeta" aria-hidden="true">#</a> processRouteMeta</h4>
<p>processRouteMeta 函数处理路由的 meta：拼接每个路由的完整路径 fullPath，处理国际化 title 显示，判断是否使用国际化等等，总之该函数是处理 meta 的配置项，这些配置项是 Admin 项目需要，并非官方的配置。</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> processRouteMeta <span class="token operator">=</span> <span class="token punctuation">(</span>routers<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> basePath <span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  routers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>router <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fullPath <span class="token operator">=</span> router<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token operator">?</span> router<span class="token punctuation">.</span>path <span class="token operator">:</span> <span class="token punctuation">(</span>basePath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> router<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理成后面布局要用到的 title。title 如果为函数，则涉及到当前路由，所以这里无法处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> useI18n<span class="token punctuation">,</span> isKeepAlive<span class="token punctuation">,</span> isFull<span class="token punctuation">,</span> useTooltip <span class="token punctuation">}</span> <span class="token operator">=</span> router<span class="token punctuation">.</span>meta<span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> routeUseI18n<span class="token punctuation">,</span> isKeepAlive<span class="token operator">:</span> keepAlive<span class="token punctuation">,</span> isFull<span class="token operator">:</span> full<span class="token punctuation">,</span> routeUseTooltip <span class="token punctuation">}</span> <span class="token operator">=</span> settings<span class="token punctuation">;</span>
      router<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>_fullPath <span class="token operator">=</span> fullPath<span class="token punctuation">;</span>
      <span class="token comment">// 这两个顺序不能互换，因为 getLayoutTitle 函数需要 useI18n</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>useI18n <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> routeUseI18n <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> router<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>useI18n <span class="token operator">=</span> routeUseI18n<span class="token punctuation">;</span>
      router<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token function">getLayoutTitle</span><span class="token punctuation">(</span>router <span class="token keyword">as</span> RouteConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isKeepAlive <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> keepAlive <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> router<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>isKeepAlive <span class="token operator">=</span> keepAlive<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isFull <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> full <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> router<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>isFull <span class="token operator">=</span> full<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>useTooltip <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> routeUseTooltip <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> router<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>useTooltip <span class="token operator">=</span> routeUseTooltip<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>router<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExternal</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">)</span> router<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">processRouteMeta</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>children<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> router<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">processRouteMeta</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>children<span class="token punctuation">,</span> fullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> routers<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该函数将会和 <code v-pre>src/config/setttings</code> 文件里的配置进行比较，<code v-pre>src/config/setttings</code> 里的配置是全局配置，这些配置包括了一些路由的配置，因此有两种情况发生：</p>
<ul>
<li>如果 meta 没有使用某个配置项，但是 settings 文件有使用该配置项，则将 settings 的配置项放到 meta 里</li>
<li>如果 meta 使用了某个配置项，则不管 settings 文件有没有配置，都已 meta 已经存在的配置项为主</li>
</ul>
<p>除了和 settings 文件配置项进行比较，该函数还处理一个非常重要的配置项：<code v-pre>_fullPath</code>。</p>
<p><code v-pre>_fullPath</code> 记录当前路由的完整路径，如：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> tableRoutes<span class="token operator">:</span> RouterConfigRaw <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">"/table"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">"Table"</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"表格"</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> <span class="token string">"Grid"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">"drag-table"</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">"DragTable"</span><span class="token punctuation">,</span>
      <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"@/views/table/dragTable/index.vue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"表格拖拽"</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> <span class="token string">"StarFilled"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么 children path 为 <code v-pre>drag-table</code> 的完整路径应该是 <code v-pre>/table/drag-table</code>，即拼上父级的 path，这是 Route 官方的规则。</p>
<p>因此开发者在项目开发的过程，可以使用 <code v-pre>route.meta._fullPath</code> 来获取该路由的完整路径。</p>
<h4 id="processdynamicroutes" tabindex="-1"><a class="header-anchor" href="#processdynamicroutes" aria-hidden="true">#</a> processDynamicRoutes</h4>
<p>processDynamicRoutes 函数用来过滤动态路由，重新生成规范路由，这里的规范路由是指帮助开发者自动生成没有使用的路由官方配置项。</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">processDynamicRoutes</span> <span class="token operator">=</span> <span class="token punctuation">(</span>routers<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>routers <span class="token operator">||</span> <span class="token operator">!</span>routers<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  routers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>r <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 将 dynamic 属性加入 meta，标识此路由为后端返回路由</span>
    r<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>_dynamic <span class="token keyword">as</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">?.</span>children <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 父级的 redirect 属性取值：如果子级存在且父级的 redirect 属性不存在，默认取第一个子级的 path；如果子级存在且父级的 redirect 属性存在，取存在的 redirect 属性，会覆盖默认值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> r<span class="token punctuation">.</span>redirect <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>meta<span class="token operator">?.</span>_fullPath <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">||</span> r<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span>
      <span class="token comment">// 父级的 name 属性取值：如果子级存在且父级的 name 属性不存在，默认取第一个子级的 name；如果子级存在且父级的 name 属性存在，取存在的 name 属性，会覆盖默认值（注意：测试中发现父级的 name 不能和子级 name 重复，如果重复会造成重定向无效（跳转 404），所以这里给父级的name起名的时候后面会自动加上 `Parent`，避免重复）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>name<span class="token punctuation">)</span> r<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"Parent"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>frameOpen <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>frameSrc <span class="token operator">&amp;&amp;</span> <span class="token function">isExternal</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>frameSrc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      r<span class="token punctuation">.</span>path <span class="token operator">=</span> r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>frameSrc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>frameKeepAlive<span class="token punctuation">)</span> r<span class="token punctuation">.</span>component <span class="token operator">=</span> FrameBlank<span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>frameKeepAlive <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>frameSrc<span class="token punctuation">)</span> r<span class="token punctuation">.</span>component <span class="token operator">=</span> FrameView<span class="token punctuation">;</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果动态路由的 component 存在且为 string，则必须是 views 下的目录，以 / 分割，如果/home/index，则是 views/home/index.vue 组件，如果不存在 component，则读取 path 来获取 component</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isType</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> r<span class="token punctuation">.</span>component <span class="token operator">=</span> modules<span class="token punctuation">[</span><span class="token string">"/src/views"</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>component <span class="token operator">+</span> <span class="token string">".vue"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> r<span class="token punctuation">.</span>component <span class="token operator">=</span> modules<span class="token punctuation">[</span><span class="token string">"/src/views"</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token string">".vue"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token operator">?.</span>children <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token function">processDynamicRoutes</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> routers<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul>
<li>如 name，如果有二级路由，且一级路由没有填写 name，则该函数自动在已经路由生成 name，name 值是二级路由的第一个 children 的 name + Parent</li>
<li>如 redirect，如果有二级路由，且一级路由没有填写 redirect，则该函数自动在一级路由生成 redirect，指向二级路由的第一个 children 的完整路径</li>
</ul>
<p>如：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> tableRoutes<span class="token operator">:</span> RouterConfigRaw <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">"/table"</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"表格"</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> <span class="token string">"Grid"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">"drag-table"</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">"DragTable"</span><span class="token punctuation">,</span>
      <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"@/views/table/dragTable/index.vue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"表格拖拽"</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> <span class="token string">"StarFilled"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>则最终生成：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> tableRoutes<span class="token operator">:</span> RouterConfigRaw <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  name<span class="token operator">:</span> <span class="token string">"DragTableParant"</span>
  redirect<span class="token operator">:</span> <span class="token string">"/table/drag-table"</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该函数还有一个主要的功能，如果你看过 <RouterLink to="/guide/basic/guide-route.html">指南 - 路由</RouterLink>，就知道路由有三种方式读取组件：</p>
<ul>
<li>官方形式：<code v-pre>component: () =&gt; import(&quot;@/views/xx/index.vue&quot;)</code></li>
<li>字符串形式：<code v-pre>component: () =&gt; xx/index</code></li>
<li>path 形式：<code v-pre>path: () =&gt; xx/index</code></li>
</ul>
<p>后两种形式是该函数处理后变成官方形式的：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isType</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> r<span class="token punctuation">.</span>component <span class="token operator">=</span> modules<span class="token punctuation">[</span><span class="token string">"/src/views"</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>component <span class="token operator">+</span> <span class="token string">".vue"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> r<span class="token punctuation">.</span>component <span class="token operator">=</span> modules<span class="token punctuation">[</span><span class="token string">"/src/views"</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token string">".vue"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="loadpermissionroutes" tabindex="-1"><a class="header-anchor" href="#loadpermissionroutes" aria-hidden="true">#</a> loadPermissionRoutes</h4>
<p>loadPermissionRoutes 函数不在 useRoute.ts 文件里，而是在 <code v-pre>src/stores/permission.ts</code> 文件里。</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre typescript="" class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> usePermissionStore <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">"permissionStore"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> loadedRouteList <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouterConfig<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> flatRouteList <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouterConfig<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> processRouteMeta<span class="token punctuation">,</span> findRouteByName<span class="token punctuation">,</span> filterFlatRoutes<span class="token punctuation">,</span> ascending <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ...</span>

  <span class="token keyword">const</span> <span class="token function-variable function">loadPermissionRoutes</span> <span class="token operator">=</span> <span class="token punctuation">(</span>routers<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    loadedRouteList<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">ascending</span><span class="token punctuation">(</span><span class="token function">processRouteMeta</span><span class="token punctuation">(</span>constantRoutes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>routers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> RouterConfig<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    flatRouteList<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">filterFlatRoutes</span><span class="token punctuation">(</span>routers<span class="token punctuation">)</span> <span class="token keyword">as</span> RouterConfig<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> flatRouteList<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line">&nbsp;</div><div class="highlight-line">&nbsp;</div><div class="highlight-line">&nbsp;</div><div class="highlight-line">&nbsp;</div><div class="highlight-line">&nbsp;</div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>将上面最终处理完的路由传入 loadPermissionRoutes，让该函数先将静态路由和传过来的路径进行处理：</p>
<ul>
<li>processRouteMeta 处理 constantRoutes 的 meta，该函数在 <code v-pre>src/hooks/useRoutes.ts</code> 文件下</li>
<li>ascending 处理排序路由的顺序，取决于 <code v-pre>meta.rank</code> 的数字大小，数字越小越靠前，该函数在 <code v-pre>src/hooks/useRoutes.ts</code> 文件下</li>
<li>最后赋值给 loadedRouteList，这样 Admin 随时使用 loadedRouteList 来获取最终 Admin 需要的路由表信息</li>
</ul>
<p>ascending 函数按照路由中 meta 下的 rank 等级升序来排序路由（仅处理以及一级路由）：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 按照路由中 meta 下的 rank 等级升序来排序路由（仅处理以及一级路由）
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">ascending</span> <span class="token operator">=</span> <span class="token punctuation">(</span>routeList<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  routeList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> r<span class="token punctuation">.</span>meta <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 当 rank 不存在时，根据顺序自动创建，首页路由永远在第一位</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token constant">HOME_NAME</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>meta<span class="token operator">?.</span>rank<span class="token punctuation">)</span> r<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>rank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handRank</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> r<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>rank <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> routeList<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">:</span> <span class="token punctuation">{</span> meta<span class="token operator">:</span> <span class="token punctuation">{</span> rank<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token punctuation">{</span> meta<span class="token operator">:</span> <span class="token punctuation">{</span> rank<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a<span class="token operator">?.</span>meta<span class="token punctuation">.</span>rank <span class="token operator">-</span> b<span class="token operator">?.</span>meta<span class="token punctuation">.</span>rank<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 过滤不需要的排序的路由
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">handRank</span> <span class="token operator">=</span> <span class="token punctuation">(</span>route<span class="token operator">:</span> RouterConfig<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> path<span class="token punctuation">,</span> meta <span class="token punctuation">}</span> <span class="token operator">=</span> route<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>meta<span class="token operator">?.</span>rank <span class="token operator">||</span> <span class="token punctuation">(</span>meta<span class="token operator">?.</span>rank <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> name <span class="token operator">!==</span> <span class="token constant">HOME_NAME</span> <span class="token operator">&amp;&amp;</span> path <span class="token operator">!==</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>filterFlatRoutes 是处理路由扁平化的函数</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token keyword">const</span> <span class="token function-variable function">filterFlatRoutes</span> <span class="token operator">=</span> <span class="token punctuation">(</span>routeList<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> routeList<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pre<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> current<span class="token operator">:</span> RouterConfigRaw<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> flatArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>pre<span class="token punctuation">,</span> current<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>children<span class="token punctuation">)</span> flatArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>flatArr<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">filterFlatRoutes</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> flatArr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="findroutebyname" tabindex="-1"><a class="header-anchor" href="#findroutebyname" aria-hidden="true">#</a> findRouteByName</h4>
<p>在路由初始化的时候，Admin 需要获取首页的路由，这在面包屑功能需要，因此在 <code v-pre>src/stores/permission.ts</code> 文件有这段代码：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token comment">// 路由里首页的 name 值，必须填且正确，默认为 Home</span>
<span class="token keyword">const</span> homeRoute <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">findRouteByName</span><span class="token punctuation">(</span>loadedRouteList<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token constant">HOME_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>HOME_NAME 是一个变量，确保这里和首页路由使用的是这个变量，这样已修改 HOME_NAME 的值，则首页都能扫描到。</p>
<p>findRouteByName 是一个路由工具函数，功能是查找 name 对应的路由信息，在 <code v-pre>src/hooks/useRoutes.ts</code> 文件下：</p>
<div class="language-typescript line-numbers-mode" data-ext="ts"><pre v-pre class="language-typescript"><code><span class="token doc-comment comment">/**
   * <span class="token keyword">@description</span> 查找 name 对应的路由信息
   * <span class="token keyword">@param</span> <span class="token parameter">routes</span> 路由表
   * <span class="token keyword">@param</span> <span class="token parameter">name</span> 查找的 name
   */</span>
<span class="token keyword">const</span> findRouteByName <span class="token operator">=</span> <span class="token punctuation">(</span>routes<span class="token operator">:</span> RouterConfig<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> RouterConfig <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>item <span class="token operator">=></span> item<span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">isProxy</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> res<span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> routes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token builtin">Array</span></span> <span class="token operator">&amp;&amp;</span> routes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token operator">?.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res <span class="token operator">=</span> <span class="token function">findRouteByName</span><span class="token punctuation">(</span>routes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">isProxy</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2>
<p>如果你没有二次开发的想法，可以不需要了解整个初始化流程，上面的流程并不需要你去做任何操作，你只需要和正常开发一样，在 view 下面写业务组件，然后里配置该路由，就可以在页面看到效果了，上面的流程在你配好路由自动执行。</p>
<p>大致总结下上面的流程，其中第一条是你需要操作，其他都是自动执行：</p>
<ul>
<li>写好自己的路由表（开发人员需要自己操作）</li>
<li>路由 beforeEach 执行初始化流程 initDynamicRouters 函数</li>
<li>判断是否有缓存，有则读取缓存的路由执行初始化</li>
<li>初始化之前先进行路由权限的扫描，在 filterOnlyRolesRoutes 函数中执行，只获取满足 roles 的路由，其他路由去掉</li>
<li>处理路由的 meta 配置项，在 processRouteMeta 函数中执行</li>
<li>处理路由的元数据，在 processDynamicRoutes 函数中执行</li>
<li>存储到 Pinia，并处理成扁平化路由，在 loadPermissionRoutes 函数中执行</li>
<li>将扁平化路由初始化加载 addRoute 到 Layout 布局路由下作为二级路由，如果存在 <code v-pre>meta.isFull</code>，则 addRoute 到一级路由下，最后并加载 404 路由</li>
</ul>
</div></template>


